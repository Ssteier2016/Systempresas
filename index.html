<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Negocios - Pro v3.9</title>
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { 
            font-family: 'Inter', system-ui, sans-serif;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }
        
        /* Splash Screen con gradiente animado */
        #splashScreen { 
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999; 
            transition: opacity .6s ease-out; 
            opacity: 1; 
            pointer-events: all;
        }
        
        #splashScreen .text-blue-600 {
            color: white !important;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }
        
        #splashScreen h1 { color: white; }
        #splashScreen p { color: rgba(255,255,255,0.8); }
        
        #mainContent { 
            opacity: 0; 
            transition: opacity .8s ease-in; 
            pointer-events: none; 
        }
        #mainContent.visible { 
            opacity: 1; 
            pointer-events: auto; 
        }
        
        /* Tarjetas con efecto glassmorphism */
        .card-border-l { 
            border-left-width: 5px;
            transition: all 0.3s ease;
        }
        
        .card-border-l:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px -8px rgba(0,0,0,0.15);
        }
        
        /* Modal overlay mejorado */
        .modal-overlay { 
            background: rgba(0,0,0,.6); 
            backdrop-filter: blur(8px);
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Tablas con hover suave */
        .table-header { 
            @apply px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table-cell { 
            @apply px-6 py-4 whitespace-nowrap text-sm text-gray-700 border-b border-gray-100;
            transition: background-color 0.15s ease;
        }
        
        tbody tr:hover .table-cell {
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        /* Input mejorado con efectos */
        .input-std { 
            @apply block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2.5 border bg-gray-50;
            transition: all 0.2s ease;
        }
        
        .input-std:focus {
            background-color: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }
        
        /* Campos protegidos con mejor estilo */
        .protected-field { 
            font-family: monospace; 
            letter-spacing: 2px;
            background: linear-gradient(135deg, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.02) 100%);
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .protected-field.revealed { 
            font-family: 'Inter', system-ui, sans-serif; 
            letter-spacing: normal;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%);
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }
        
        /* Menú lateral con sombra elegante */
        #sideMenu { 
            transform: translateX(-100%); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 4px 0 24px rgba(0,0,0,0.15);
        }
        
        #sideMenu.open { 
            transform: translateX(0); 
        }
        
        /* Botones con efectos hover mejorados */
        button {
            transition: all 0.2s ease;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        /* Botones principales con gradientes */
        .bg-blue-600 {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .bg-blue-600:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }
        
        /* Cards del dashboard con efectos */
        .bg-white {
            transition: all 0.3s ease;
        }
        
        .group:hover .bg-orange-100,
        .group:hover .bg-blue-100,
        .group:hover .bg-green-100,
        .group:hover .bg-red-100,
        .group:hover .bg-indigo-100 {
            transform: scale(1.1) rotate(5deg);
        }
        
        /* Animación para iconos */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Efectos para badges y etiquetas */
        .bg-gray-100 {
            transition: all 0.2s ease;
        }
        
        #connectionStatus:hover {
            background-color: #e5e7eb;
            transform: scale(1.05);
        }
        
        /* Efecto para modales al aparecer */
        .modal-overlay > div {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800 overflow-x-hidden">

    <div id="splashScreen">
        <div class="text-center">
            <div class="text-6xl text-blue-600 mb-4 animate-bounce"><i class="fas fa-chart-pie"></i></div>
            <h1 class="text-xl font-bold text-gray-700">Cargando Sistema...</h1>
            <p class="text-sm text-gray-400 mt-2">v3.9 - Diseño Unificado</p>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('splashScreen');
                const main = document.getElementById('mainContent');
                if(splash) { splash.style.opacity = '0'; setTimeout(() => splash.style.display = 'none', 600); }
                if(main) { main.classList.add('visible'); main.style.pointerEvents = 'auto'; }
            }, 1500);
        });
    </script>

    <!-- MENÚ LATERAL -->
    <div id="sideMenuOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden"></div>
    <div id="sideMenu" class="fixed top-0 left-0 h-full w-80 bg-white shadow-2xl z-[70] flex flex-col">
        <div class="p-6 bg-blue-600 text-white flex justify-between items-center"><h2 class="text-xl font-bold"><i class="fas fa-store mr-2"></i> Mi Tienda</h2><button id="closeSideMenuBtn" class="text-white hover:text-gray-200"><i class="fas fa-times text-xl"></i></button></div>
        <div class="p-6 flex-1 overflow-y-auto">
            <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">Gestión de Personal</h3>
            <button id="btnOpenEmployeeStats" class="w-full bg-indigo-50 text-indigo-700 py-3 rounded-xl font-bold shadow-sm mb-6 flex items-center justify-center gap-2 hover:bg-indigo-100 transition"><i class="fas fa-users-cog"></i> Ver Sueldos y Horas</button>
            <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Lista de Empleados</h4>
            <form id="addEmployeeForm" class="flex gap-2 mb-4"><input type="text" id="newEmployeeInput" class="input-std text-sm" placeholder="Agregar nombre..." required><button type="submit" class="bg-blue-600 text-white px-3 rounded-lg"><i class="fas fa-plus"></i></button></form>
            <div id="employeeListContainer" class="space-y-2"></div>
        </div>
        <div class="p-4 bg-gray-50 border-t text-center text-xs text-gray-400">Sistema v3.9 Pro</div>
    </div>

    <div id="mainContent">
        <nav class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <button id="openSideMenuBtn" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-bars"></i></button>
                    <div class="flex items-center gap-2 p-2 rounded-lg"><span id="storeNameDisplay" class="text-xl font-bold text-gray-800 tracking-tight">MI NEGOCIO</span></div>
                </div>
                <div class="flex gap-4 text-gray-500 items-center">
                    <div id="connectionStatus" class="text-xs bg-gray-100 px-2 py-1 rounded-full text-gray-500 hidden md:block"><i class="fas fa-circle text-[8px] mr-1"></i> Iniciando...</div>
                    <button id="openProfileModalBtn" class="hover:text-blue-600 text-2xl transition transform hover:scale-110"><i class="fas fa-user-circle"></i></button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div><h1 class="text-2xl font-bold text-gray-900">Panel de Control</h1><p class="text-sm text-gray-500">Resumen de actividad en tiempo real</p></div>
                <div class="text-right bg-white px-4 py-2 rounded-xl shadow-sm border border-gray-100 flex flex-col items-end min-w-[150px]">
                    <div id="currentDateDisplay" class="text-sm font-bold text-blue-600 capitalize">Cargando fecha...</div>
                    <div id="currentTimeDisplay" class="text-xs text-gray-400">--:--:--</div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                <button id="openInventarioBtn" class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition text-center group border border-gray-100 cursor-pointer">
                    <div class="w-10 h-10 mx-auto bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mb-2 group-hover:scale-110 transition"><i class="fas fa-box"></i></div>
                    <div class="font-semibold text-sm">Inventario</div>
                    <div class="text-xs text-gray-400 mt-1">Total: <span id="dashTotalProductos">0</span></div>
                </button>
                <button id="openVentasHistoryBtn" class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition text-center group border border-gray-100 cursor-pointer relative">
                    <div class="absolute top-2 right-2 text-gray-300"><i class="fas fa-lock text-xs"></i></div>
                    <div class="w-10 h-10 mx-auto bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-2 group-hover:scale-110 transition"><i class="fas fa-shopping-cart"></i></div>
                    <div class="font-semibold text-sm">Ver Ventas</div>
                    <div class="text-xs text-gray-400 mt-1">Hoy: <span id="dashVentasHoy">$0</span></div>
                </button>
                <button id="openGananciasHistoryBtn" class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition text-center group border border-gray-100 relative overflow-hidden cursor-pointer">
                    <div class="absolute top-2 right-2 text-gray-300"><i class="fas fa-lock text-xs"></i></div>
                    <div class="w-10 h-10 mx-auto bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-2 group-hover:scale-110 transition"><i class="fas fa-chart-line"></i></div>
                    <div class="font-semibold text-sm">Ver Ganancias</div>
                    <div class="text-xs text-gray-400 mt-1">Rentabilidad</div>
                </button>
                <button id="openGastosHistoryBtn" class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition text-center group border border-gray-100 cursor-pointer">
                    <div class="w-10 h-10 mx-auto bg-red-100 text-red-600 rounded-full flex items-center justify-center mb-2 group-hover:scale-110 transition"><i class="fas fa-receipt"></i></div>
                    <div class="font-semibold text-sm">Ver Gastos</div>
                    <div class="text-xs text-gray-400 mt-1">Hoy: <span id="dashGastosHoy">$0</span></div>
                </button>
                <button id="openClientesBtn" class="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition text-center group border border-gray-100 cursor-pointer">
                    <div class="w-10 h-10 mx-auto bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mb-2 group-hover:scale-110 transition"><i class="fas fa-users"></i></div>
                    <div class="font-semibold text-sm">Clientes</div>
                    <div class="text-xs text-gray-400 mt-1"><span id="dashTotalClientes">0</span> reg.</div>
                </button>
            </div>

            <div class="flex gap-3 mb-8">
                <button id="btnNewProduct" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl shadow-lg shadow-blue-200 transition font-medium flex justify-center items-center gap-2 cursor-pointer active:scale-95"><i class="fas fa-plus"></i> Producto</button>
                <button id="btnNewSale" class="flex-1 bg-gray-900 hover:bg-gray-800 text-white py-3 rounded-xl shadow-lg shadow-gray-300 transition font-medium flex justify-center items-center gap-2 cursor-pointer active:scale-95"><i class="fas fa-plus"></i> Venta</button>
                <button id="btnNewExpense" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl shadow-lg shadow-red-200 transition font-medium flex justify-center items-center gap-2 cursor-pointer active:scale-95"><i class="fas fa-minus"></i> Gasto</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-border-l border-blue-500 relative">
                    <div class="flex justify-between items-start mb-2"><div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Ventas (Mes)</div><button class="text-gray-400 hover:text-blue-600 cursor-pointer" data-toggle-privacy="sales"><i class="fas fa-eye"></i></button></div>
                    <div class="text-2xl font-bold text-gray-900 protected-field" id="cardVentasMes">******</div>
                    <div class="mt-2 text-xs text-green-600 flex items-center"><i class="fas fa-calendar-day mr-1"></i> Hoy: <span id="cardVentasHoy" class="ml-1 font-semibold">$0.00</span></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-border-l border-green-500 relative">
                    <div class="flex justify-between items-start mb-2"><div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Ganancia Neta (Mes)</div><button class="text-gray-400 hover:text-green-600 cursor-pointer" data-toggle-privacy="profit"><i class="fas fa-eye"></i></button></div>
                    <div class="text-2xl font-bold text-gray-900 protected-field" id="cardGananciaMes">******</div>
                    <div class="mt-2 text-xs text-gray-500 flex items-center">Ventas - Gastos</div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-border-l border-yellow-500 relative">
                    <div class="flex justify-between items-start mb-2"><div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Caja Actual</div><button class="text-gray-400 hover:text-yellow-600 cursor-pointer" id="btnOpenCashModal"><i class="fas fa-external-link-alt"></i></button></div>
                    <div class="text-2xl font-bold text-gray-900 protected-field" id="cardCaja">******</div>
                    <div class="mt-2 text-xs text-yellow-600 font-semibold">Click ícono para detalle</div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-border-l border-orange-500 relative">
                    <div class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2">Stock Total</div>
                    <div class="text-2xl font-bold text-gray-900" id="cardStockUnidades">0</div>
                    <div class="mt-2 text-xs text-gray-500">Unidades Físicas</div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-8">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-bullhorn text-purple-500"></i> Notas / Novedades</h3>
                <div class="flex gap-2">
                    <textarea id="dailyNoteInput" rows="2" class="input-std" placeholder="Escribe un recordatorio o novedad del día..."></textarea>
                    <button id="sendWhatsappBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 rounded-lg shadow-sm transition cursor-pointer"><i class="fab fa-whatsapp text-xl"></i></button>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALES -->

    <div id="listManagerModal" class="modal-overlay fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl"><h3 class="font-bold text-gray-700">Gestionar Lista</h3><button data-close="listManagerModal" class="text-gray-400"><i class="fas fa-times"></i></button></div>
            <div class="p-4">
                <p class="text-xs text-gray-500 mb-2">Elimina elementos con el botón de borrar.</p>
                <ul id="listManagerItems" class="space-y-2 max-h-60 overflow-y-auto"></ul>
            </div>
        </div>
    </div>

    <div id="employeeStatsModal" class="modal-overlay fixed inset-0 z-[80] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-indigo-50 rounded-t-2xl"><h2 class="text-xl font-bold text-indigo-800"><i class="fas fa-user-clock mr-2"></i> Rendimiento</h2><button data-close="employeeStatsModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button></div>
            <div class="p-6 bg-white border-b"><div class="flex gap-2"><select id="filterStatsMonth" class="input-std w-40"><option value="all">Mes Actual</option><option value="all_year">Todo el Año</option></select><button id="refreshEmployeeStats" class="bg-indigo-600 text-white px-4 rounded-lg"><i class="fas fa-sync-alt"></i></button></div></div>
            <div class="flex-1 overflow-y-auto p-0"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="table-header">Empleado</th><th class="table-header text-center">Turnos</th><th class="table-header text-center">Horas</th><th class="table-header text-right">Retiros</th></tr></thead><tbody id="employeeStatsTableBody" class="bg-white divide-y divide-gray-100"></tbody></table></div>
        </div>
    </div>

    <!-- MODAL HISTORIAL GANANCIAS (REDISEÑADO ESTILO VENTAS) -->
    <div id="gananciasDetailModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <!-- Header idéntico a Ventas -->
            <div class="p-6 border-b flex justify-between items-center bg-green-50 rounded-t-2xl">
                <div>
                    <h2 class="text-xl font-bold text-green-800">Historial de Rentabilidad</h2>
                    <div class="text-sm font-medium mt-1" id="profitHeaderSummary">Cargando...</div>
                </div>
                <button data-close="gananciasDetailModal" class="text-gray-400 text-xl"><i class="fas fa-times"></i></button>
            </div>
            <!-- Barra de Filtros idéntica a Ventas -->
            <div class="p-4 bg-white border-b flex flex-wrap gap-2 items-center">
                <div class="flex gap-2 items-center">
                    <select id="filterProfitMonth" class="input-std w-32 text-sm"><option value="all">Mes: Todos</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option></select>
                    <select id="filterProfitYear" class="input-std w-24 text-sm"><option value="all">Año: Todos</option><option value="2025">2025</option><option value="2024">2024</option></select>
                    <button id="applyProfitFilterBtn" class="bg-green-600 text-white px-3 py-2 rounded-lg"><i class="fas fa-filter"></i></button>
                </div>
            </div>
            <!-- Tabla idéntica a Ventas -->
            <div class="overflow-y-auto flex-1 p-0">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0"><tr><th class="table-header">Fecha</th><th class="table-header text-right">Ventas</th><th class="table-header text-right">Gastos</th><th class="table-header text-right">Balance Neto</th></tr></thead>
                    <tbody id="profitTableBody" class="bg-white divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="salesHistoryModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-blue-50 rounded-t-2xl"><div><h2 class="text-xl font-bold text-blue-700">Historial de Ventas</h2><p class="text-sm text-blue-500" id="salesHistoryTotalLabel">Total: $0.00</p></div><button data-close="salesHistoryModal" class="text-gray-400 text-xl"><i class="fas fa-times"></i></button></div>
            <div class="p-4 bg-white border-b flex flex-wrap gap-2 items-center">
                <input type="text" id="searchSaleInput" placeholder="Buscar cliente..." class="input-std w-40">
                <div class="border-l pl-2 flex gap-2 items-center">
                    <span class="text-xs text-gray-400 font-bold">FECHA:</span><input type="date" id="filterSaleDate" class="input-std w-auto text-sm">
                    <span class="text-xs text-gray-400">O</span>
                    <select id="filterSaleMonth" class="input-std w-32 text-sm"><option value="all">Mes: Todos</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option></select>
                    <select id="filterSaleYear" class="input-std w-24 text-sm"><option value="all">Año</option><option value="2025">2025</option><option value="2024">2024</option></select>
                    <button id="applySalesFilter" class="bg-blue-600 text-white px-3 py-2 rounded-lg"><i class="fas fa-filter"></i></button>
                    <button id="resetSalesFilter" class="bg-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-300"><i class="fas fa-undo"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-0"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50 sticky top-0"><tr><th class="table-header">Fecha / Hora</th><th class="table-header">Cliente</th><th class="table-header">Producto</th><th class="table-header">Canal</th><th class="table-header">Pago</th><th class="table-header">Encargado / Turno</th><th class="table-header text-right">Monto</th></tr></thead><tbody id="salesTableBody" class="bg-white divide-y divide-gray-100"></tbody></table></div>
        </div>
    </div>

    <div id="expensesHistoryModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center"><h2 class="text-xl font-bold text-red-600">Historial de Gastos</h2><p class="text-sm text-red-500" id="expensesHistoryTotalLabel">Total: $0.00</p><button data-close="expensesHistoryModal" class="text-gray-400 text-xl"><i class="fas fa-times"></i></button></div>
            <div class="p-4 bg-gray-50 border-b flex flex-wrap gap-2 items-center">
                <input type="text" id="searchExpenseInput" placeholder="Buscar..." class="input-std w-40">
                <div class="border-l pl-2 flex gap-2 items-center">
                    <input type="date" id="filterExpenseDate" class="input-std w-auto text-sm">
                    <select id="filterExpenseMonth" class="input-std w-32 text-sm"><option value="all">Mes: Todos</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option></select>
                    <select id="filterExpenseYear" class="input-std w-24 text-sm"><option value="all">Año</option><option value="2025">2025</option><option value="2024">2024</option></select>
                    <button id="applyExpenseFilter" class="bg-red-500 text-white px-3 py-2 rounded-lg"><i class="fas fa-filter"></i></button>
                    <button id="resetExpenseFilter" class="bg-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-300"><i class="fas fa-undo"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-0"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="table-header">Fecha</th><th class="table-header">Categoría</th><th class="table-header">Encargado</th><th class="table-header text-right">Monto</th></tr></thead><tbody id="expensesTableBody" class="bg-white divide-y divide-gray-100"></tbody></table></div>
        </div>
    </div>

    <div id="cashDetailModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center bg-yellow-50 rounded-t-2xl"><h2 class="text-xl font-bold text-yellow-700">Arqueo de Caja</h2><button data-close="cashDetailModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button></div>
            <div class="p-6 border-b grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div class="bg-green-50 p-3 rounded-lg"><div class="text-xs text-green-600 font-bold uppercase">Ganancia Bruta</div><div class="text-lg font-bold text-green-800" id="cashModalGross">$0.00</div></div>
                <div class="bg-red-50 p-3 rounded-lg"><div class="text-xs text-red-600 font-bold uppercase">Retiros Manuales</div><div class="text-lg font-bold text-red-800" id="cashModalWithdrawals">$0.00</div></div>
                <div class="bg-yellow-50 p-3 rounded-lg border-2 border-yellow-200"><div class="text-xs text-yellow-600 font-bold uppercase">En Caja Real</div><div class="text-2xl font-bold text-yellow-800" id="cashModalNet">$0.00</div></div>
            </div>
            <div class="p-6 bg-gray-50"><form id="withdrawalForm" class="flex gap-2 flex-wrap md:flex-nowrap"><input type="number" id="wdAmount" placeholder="Monto ($)" class="input-std w-32" required><input type="text" id="wdEmployee" list="managerList" placeholder="Empleado..." class="input-std" required><input type="text" id="wdNote" placeholder="Motivo..." class="input-std flex-1"><button type="submit" class="bg-red-500 text-white px-4 rounded-lg hover:bg-red-600">Retirar</button></form></div>
            <div class="flex-1 overflow-y-auto p-0"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Empleado</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Monto</th></tr></thead><tbody id="withdrawalsTableBody" class="bg-white divide-y divide-gray-100"></tbody></table></div>
        </div>
    </div>

    <!-- OTROS MODALES DE CARGA -->
    <div id="newSaleModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"><div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10"><h2 class="text-xl font-bold">Registrar Venta</h2><button data-close="newSaleModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button></div><form id="saleForm" class="p-6 space-y-4"><div class="grid grid-cols-3 gap-4"><div><label class="block text-sm font-medium text-gray-700">Fecha</label><input type="date" id="saleDate" class="input-std" required></div><div><label class="block text-sm font-medium text-gray-700">Hora</label><input type="time" id="saleTime" class="input-std" required></div><div><label class="block text-sm font-medium text-gray-700">Turno</label><input type="text" id="saleShift" class="input-std bg-gray-100 text-gray-500" readonly></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Encargado</label><input type="text" id="saleEmployee" list="managerList" class="input-std" required><datalist id="managerList"></datalist></div><div><label class="block text-sm font-medium text-gray-700">Monto ($)</label><input type="number" id="saleAmount" step="0.01" class="input-std font-bold text-lg" required></div></div><div class="bg-blue-50 p-4 rounded-xl border border-blue-100"><label class="block text-sm font-bold text-blue-700 mb-2">Cliente</label><div class="space-y-3"><input type="text" id="saleClient" list="clientList" class="input-std" placeholder="Nombre" required><datalist id="clientList"></datalist><div class="grid grid-cols-2 gap-4"><input type="tel" id="saleWhatsapp" class="input-std" placeholder="WhatsApp"><input type="email" id="saleEmail" class="input-std" placeholder="Email"></div></div></div><div class="grid grid-cols-2 gap-4"><div class="relative"><label class="block text-sm font-medium text-gray-700">Pago</label><div class="flex gap-1"><input type="text" id="salePayment" list="paymentList" class="input-std"><button type="button" class="text-gray-400 hover:text-blue-600 px-2" onclick="openManager('paymentType')"><i class="fas fa-cog"></i></button></div><datalist id="paymentList"></datalist></div><div class="relative"><label class="block text-sm font-medium text-gray-700">Canal</label><div class="flex gap-1"><input type="text" id="saleChannel" list="channelList" class="input-std"><button type="button" class="text-gray-400 hover:text-blue-600 px-2" onclick="openManager('salesChannel')"><i class="fas fa-cog"></i></button></div><datalist id="channelList"></datalist></div></div><div class="relative"><label class="block text-sm font-medium text-gray-700">Producto/Ropa</label><div class="flex gap-1"><input type="text" id="saleClothingType" list="clothingTypeList" class="input-std"><button type="button" class="text-gray-400 hover:text-blue-600 px-2" onclick="openManager('clothingType')"><i class="fas fa-cog"></i></button></div><datalist id="clothingTypeList"></datalist></div><div><label class="block text-sm font-medium text-gray-700">Notas</label><textarea id="saleNotes" rows="2" class="input-std"></textarea></div><button type="submit" class="w-full bg-gray-900 hover:bg-gray-800 text-white py-3 rounded-xl font-bold shadow-md cursor-pointer">Guardar Venta</button></form></div></div>
    <div id="newExpenseModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-xl font-bold">Registrar Gasto</h2><button data-close="newExpenseModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button></div><form id="expenseForm" class="p-6 space-y-4"><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Fecha</label><input type="date" id="expenseDate" class="input-std" required></div><div><label class="block text-sm font-medium text-gray-700">Monto ($)</label><input type="number" id="expenseAmount" step="0.01" class="input-std font-bold text-lg text-red-600" required></div></div><div class="relative"><label class="block text-sm font-medium text-gray-700">Categoría</label><div class="flex gap-1"><input type="text" id="expenseCategory" list="categoryList" class="input-std"><button type="button" class="text-gray-400 hover:text-blue-600 px-2" onclick="openManager('category')"><i class="fas fa-cog"></i></button></div><datalist id="categoryList"></datalist></div><div class="relative"><label class="block text-sm font-medium text-gray-700">Encargado</label><div class="flex gap-1"><input type="text" id="expenseManager" list="managerList" class="input-std"><button type="button" class="text-gray-400 hover:text-blue-600 px-2" onclick="openManager('manager')"><i class="fas fa-cog"></i></button></div></div><div><label class="block text-sm font-medium text-gray-700">Descripción</label><input type="text" id="expenseDesc" class="input-std"></div><button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold shadow-md cursor-pointer">Guardar Gasto</button></form></div></div>
    <div id="productModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-xl font-bold">Nuevo Producto</h2><button data-close="productModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button></div><form id="productForm" class="p-6 space-y-4"><input type="text" id="prodName" placeholder="Nombre" class="input-std" required><div class="relative"><label class="block text-sm font-medium text-gray-700">Tipo</label><div class="flex gap-1"><input type="text" id="prodType" list="prodTypeList" class="input-std" required><button type="button" class="text-gray-400 hover:text-blue-600 px-2" onclick="openManager('prodType')"><i class="fas fa-cog"></i></button></div><datalist id="prodTypeList"><option value="Importado"><option value="Nacional"><option value="Nuevo"></datalist></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Precio ARS</label><input type="number" id="prodPrice" class="input-std"></div><div><label class="block text-sm font-medium text-gray-700">Precio USD</label><input type="number" id="prodPriceUsd" class="input-std"></div></div><div><label class="block text-sm font-medium text-gray-700">Stock</label><input type="number" id="prodStock" class="input-std" required></div><button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-xl font-bold cursor-pointer">Guardar</button></form></div></div>
    <div id="newClientModal" class="modal-overlay fixed inset-0 z-[60] hidden flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md"><div class="p-6 border-b flex justify-between items-center"><h2 class="text-xl font-bold text-indigo-700">Nuevo Cliente</h2><button data-close="newClientModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button></div><form id="clientForm" class="p-6 space-y-4"><input type="text" id="newClientName" class="input-std" placeholder="Nombre Completo" required><input type="tel" id="newClientWhatsapp" class="input-std" placeholder="WhatsApp"><input type="email" id="newClientEmail" class="input-std" placeholder="Email"><button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold shadow-md cursor-pointer">Guardar Cliente</button></form></div></div>
    <div id="clientsModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col"><div class="p-6 border-b flex justify-between items-center bg-indigo-50 rounded-t-2xl"><h2 class="text-xl font-bold text-indigo-700">Base de Clientes</h2><button data-close="clientsModal" class="text-gray-400 text-xl cursor-pointer"><i class="fas fa-times"></i></button></div><div class="p-4 bg-white border-b flex flex-wrap gap-2 items-center"><input type="text" id="searchClientInput" placeholder="Buscar por nombre..." class="input-std w-40"><div class="border-l pl-2 flex gap-2 items-center"><select id="filterClientMonth" class="input-std w-32 text-sm"><option value="all">Mes: Todos</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option></select><select id="filterClientYear" class="input-std w-24 text-sm"><option value="all">Año</option><option value="2025">2025</option><option value="2024">2024</option></select><button id="applyClientFilter" class="bg-indigo-600 text-white px-3 py-2 rounded-lg"><i class="fas fa-filter"></i></button></div><button id="btnAddClientDirect" class="bg-indigo-600 text-white px-4 rounded-lg ml-auto"><i class="fas fa-plus"></i></button></div><div class="flex-1 overflow-y-auto p-0"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="table-header">Nombre</th><th class="table-header">Contacto</th><th class="table-header">Email</th><th class="table-header text-right">Historial</th></tr></thead><tbody id="clientsTableBody" class="bg-white divide-y divide-gray-100"></tbody></table></div></div></div>
    <div id="inventoryModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col"><div class="p-6 border-b flex justify-between items-center bg-orange-50 rounded-t-2xl"><h2 class="text-xl font-bold text-orange-600">Inventario</h2><button data-close="inventoryModal" class="text-gray-400 text-xl"><i class="fas fa-times"></i></button></div><div class="p-4 bg-white border-b flex flex-wrap gap-2 items-center"><input type="text" id="searchInventoryInput" placeholder="Buscar producto..." class="input-std w-40"><div class="border-l pl-2 flex gap-2 items-center"><span class="text-xs text-gray-400 font-bold">CREADO:</span><input type="date" id="filterInvDate" class="input-std w-auto text-sm"><select id="filterInvMonth" class="input-std w-32 text-sm"><option value="all">Mes: Todos</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option></select><select id="filterInvYear" class="input-std w-24 text-sm"><option value="all">Año</option><option value="2025">2025</option><option value="2024">2024</option></select><button id="applyInvFilter" class="bg-orange-500 text-white px-3 py-2 rounded-lg"><i class="fas fa-filter"></i></button><button id="resetInvFilter" class="bg-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-300"><i class="fas fa-undo"></i></button></div></div><div class="flex-1 overflow-y-auto p-0"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="table-header">Producto</th><th class="table-header">Tipo</th><th class="table-header text-right">Stock</th><th class="table-header text-right">Precio ARS</th><th class="table-header text-right">Precio USD</th></tr></thead><tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-100"></tbody></table></div></div></div>
    <div id="authModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center"><div class="mb-4 text-4xl text-blue-600"><i class="fas fa-lock"></i></div><h3 class="text-xl font-bold mb-2">Acceso Restringido</h3><p class="text-gray-500 text-sm mb-6">Ingrese PIN para continuar.</p><input type="password" id="pinInput" maxlength="4" class="text-center text-3xl tracking-[0.5em] font-bold w-full border-b-2 border-gray-300 focus:border-blue-600 outline-none pb-2 mb-6" placeholder="••••"><div class="flex gap-2"><button id="cancelAuth" class="flex-1 py-2 text-gray-500 bg-gray-100 rounded-lg">Cancelar</button><button id="confirmAuth" class="flex-1 py-2 text-white bg-blue-600 rounded-lg">Acceder</button></div></div></div>
    <div id="profileModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6"><h3 class="text-lg font-bold mb-4">Perfil</h3><div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm"><p><strong>Estado:</strong> <span id="authStatusText" class="text-green-600">Conectado</span></p><p class="text-xs text-gray-400 truncate mt-1" id="uidDisplay">...</p></div><button id="googleLoginBtn" class="w-full border py-2 rounded-lg hover:bg-gray-50 mb-2 flex items-center justify-center gap-2"><i class="fab fa-google text-red-500"></i> Google Login</button><button id="logoutBtn" class="w-full bg-red-100 text-red-600 py-2 rounded-lg hover:bg-red-200">Cerrar Sesión</button><button data-close="profileModal" class="w-full mt-4 text-gray-400 text-sm">Cerrar</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        let firebaseConfig;
        if(typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = { apiKey: "fake-key", authDomain: "fake.firebaseapp.com", projectId: "fake-project" };
        }
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const SECURE_PIN = "1440";

        let userId = null;
        let products=[], sales=[], expenses=[], clients=[], withdrawals=[];
        let settings = { storeName: "MI NEGOCIO", employees: [], blockedCategories: {} };
        let privacyRevealed = { sales: false, profit: false, cash: false };
        let pendingAction = null;

        const $ = id => document.getElementById(id);
        const fmtMoney = n => `$${parseFloat(n||0).toLocaleString('en-US',{minimumFractionDigits:2, maximumFractionDigits:2})}`;
        const fmtDate = s => { if(!s)return'-'; const [y,m,d]=s.split('-'); return `${d}/${m}/${y}`; };
        const getToday = () => new Date().toISOString().split('T')[0];
        window.openManager = (type) => openListManager(type);

        function updateClock() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if($('currentDateDisplay')) $('currentDateDisplay').textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
            if($('currentTimeDisplay')) $('currentTimeDisplay').textContent = now.toLocaleTimeString('es-ES');
        }
        setInterval(updateClock, 1000); updateClock();

        const updateProtectedField = (id, value) => {
            const el = $(id); if(!el) return;
            el.dataset.realValue = value;
            if(el.classList.contains('revealed')) el.textContent = value; else el.textContent = '******';
        };

        const initAuth = async () => {
            onAuthStateChanged(auth, user => {
                if(user) {
                    userId = user.uid;
                    $('connectionStatus').innerHTML = '<i class="fas fa-circle text-[8px] mr-1 text-green-500"></i> En Línea';
                    $('authStatusText').textContent = "Conectado";
                    $('uidDisplay').textContent = user.isAnonymous ? `Anon: ${user.uid.substr(0,5)}` : user.email;
                    initListeners();
                } else {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
                     else signInAnonymously(auth);
                }
            });
        };
        initAuth();

        function initListeners() {
            const path = c => collection(db, 'artifacts', appId, 'users', userId, c);
            onSnapshot(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'config'), (s) => {
                if(s.exists()) {
                    settings = { ...settings, ...s.data() };
                    if(!settings.blockedCategories) settings.blockedCategories = {};
                    $('storeNameDisplay').textContent = settings.storeName || "MI NEGOCIO";
                    renderEmployeeList();
                    updateDynamicLists(); 
                }
            });
            onSnapshot(path('products'), s => { products = s.docs.map(d=>d.data()); updateDashboard(); renderInventory(); });
            onSnapshot(path('sales'), s => { sales = s.docs.map(d=>d.data()); updateDashboard(); renderSalesList(); updateDynamicLists(); });
            onSnapshot(path('expenses'), s => { expenses = s.docs.map(d=>d.data()); updateDashboard(); renderExpensesList(); updateDynamicLists(); });
            onSnapshot(path('clients'), s => { clients = s.docs.map(d=>d.data()); updateDashboard(); renderClientsTable(); }); 
            onSnapshot(path('withdrawals'), s => { withdrawals = s.docs.map(d=>d.data()); updateDashboard(); renderWithdrawalsList(); });
        }

        let detectedLists = {};
        function updateDynamicLists() {
            const payMethods = new Set(['Efectivo', 'Tarjeta Crédito', 'Tarjeta Débito', 'Transferencia', 'QR']);
            const channels = new Set(['Local Físico', 'WhatsApp', 'Instagram', 'Sitio Web']);
            const clothingTypes = new Set(['Remera', 'Pantalón', 'Vestido', 'Accesorios']);
            const prodTypes = new Set(['Importado', 'Nacional', 'Nuevo']);
            const cats = new Set(['Mercadería', 'Servicios', 'Alquiler', 'Varios']);
            const managers = new Set(settings.employees || []);
            const isBlocked = (type, val) => (settings.blockedCategories[type] || []).includes(val);
            sales.forEach(s => {
                if(s.paymentType && !isBlocked('paymentType', s.paymentType)) payMethods.add(s.paymentType);
                if(s.salesChannel && !isBlocked('salesChannel', s.salesChannel)) channels.add(s.salesChannel);
                if(s.clothingType && !isBlocked('clothingType', s.clothingType)) clothingTypes.add(s.clothingType);
            });
            expenses.forEach(e => {
                if(e.category && !isBlocked('category', e.category)) cats.add(e.category);
                if(e.manager && !isBlocked('manager', e.manager)) managers.add(e.manager);
            });
            products.forEach(p => { if(p.prodType && !isBlocked('prodType', p.prodType)) prodTypes.add(p.prodType); });
            detectedLists = { paymentType: payMethods, salesChannel: channels, clothingType: clothingTypes, category: cats, manager: managers, prodType: prodTypes };
            const fill = (id, set) => { $(id).innerHTML = ''; Array.from(set).sort().forEach(val => $(id).innerHTML += `<option value="${val}">`); };
            fill('paymentList', payMethods); fill('channelList', channels); fill('clothingTypeList', clothingTypes); fill('categoryList', cats); fill('managerList', managers); fill('prodTypeList', prodTypes);
        }

        function openListManager(type) {
            const list = detectedLists[type] || new Set();
            const container = $('listManagerItems'); container.innerHTML = '';
            Array.from(list).sort().forEach(item => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-gray-50 p-2 rounded border";
                li.innerHTML = `<span>${item}</span>`;
                const btn = document.createElement('button');
                btn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                btn.className = "text-red-500 hover:text-red-700 px-2 cursor-pointer";
                btn.onclick = async () => {
                    if(confirm(`¿Bloquear "${item}"?`)) {
                        try {
                            const newBlockedList = [...(settings.blockedCategories[type] || []), item];
                            const updatedBlocked = { ...settings.blockedCategories, [type]: newBlockedList };
                            await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'config'), { blockedCategories: updatedBlocked }, { merge: true });
                            li.remove();
                        } catch(e) { console.error(e); alert("Error al eliminar"); }
                    }
                };
                li.appendChild(btn); container.appendChild(li);
            });
            $('listManagerModal').classList.remove('hidden');
        }

        function detectShift(timeStr) {
            if(!timeStr) return '';
            const [h, m] = timeStr.split(':').map(Number);
            const floatTime = h + m/60;
            if (floatTime >= 10 && floatTime < 16) return 'Turno Mañana';
            if (floatTime >= 16 && floatTime <= 21) return 'Turno Tarde';
            return 'Fuera de Horario';
        }

        function updateDashboard() {
            const today = getToday();
            const thisMonth = today.slice(0,7);
            let sToday = 0, sMonth = 0;
            sales.forEach(s => { const a = parseFloat(s.montoCobrado)||0; if(s.date===today) sToday+=a; if(s.date.startsWith(thisMonth)) sMonth+=a; });
            let eToday = 0, eMonth = 0;
            expenses.forEach(e => { const a = parseFloat(e.gastoTotal)||0; if(e.date===today) eToday+=a; if(e.date.startsWith(thisMonth)) eMonth+=a; });
            const wTotal = withdrawals.reduce((a,w)=>a+(parseFloat(w.amount)||0),0);
            const sTotal = sales.reduce((a,s)=>a+(parseFloat(s.montoCobrado)||0),0);
            const eTotal = expenses.reduce((a,e)=>a+(parseFloat(e.gastoTotal)||0),0);
            $('dashVentasHoy').textContent = fmtMoney(sToday);
            $('dashGastosHoy').textContent = fmtMoney(eToday);
            $('dashTotalProductos').textContent = products.reduce((a,p)=>a+(parseInt(p.stock)||0),0);
            $('cardVentasHoy').textContent = fmtMoney(sToday);
            $('cardStockUnidades').textContent = products.reduce((a,p)=>a+(parseInt(p.stock)||0),0);
            $('dashTotalClientes').textContent = clients.length;
            updateProtectedField('cardVentasMes', fmtMoney(sMonth));
            updateProtectedField('cardGananciaMes', fmtMoney(sMonth - eMonth));
            updateProtectedField('cardCaja', fmtMoney(sTotal - eTotal - wTotal));
            $('cashModalGross').textContent = fmtMoney(sTotal - eTotal);
            $('cashModalWithdrawals').textContent = fmtMoney(wTotal);
            $('cashModalNet').textContent = fmtMoney(sTotal - eTotal - wTotal);
        }

        const filterByDate = (item, dateField, fDate, fMonth, fYear) => {
            if(!item[dateField]) return false;
            const d = item[dateField];
            if(fDate && d !== fDate) return false;
            if(fDate) return true;
            const [y, mStr] = d.split('-');
            const m = parseInt(mStr) - 1;
            if(fMonth !== 'all' && m !== parseInt(fMonth)) return false;
            if(fYear !== 'all' && parseInt(y) !== parseInt(fYear)) return false;
            return true;
        };

        function renderProfitReport() {
            const tb = $('profitTableBody'); tb.innerHTML = '';
            const fMonth = $('filterProfitMonth').value;
            const fYear = $('filterProfitYear').value;

            const daily = {};
            const addToDay = (list, key, field) => {
                list.forEach(i => {
                    if(filterByDate(i, 'date', null, fMonth, fYear)) {
                        if(!daily[i.date]) daily[i.date] = { s:0, e:0 };
                        daily[i.date][key] += (parseFloat(i[field])||0);
                    }
                });
            };
            addToDay(sales, 's', 'montoCobrado');
            addToDay(expenses, 'e', 'gastoTotal');

            const sorted = Object.keys(daily).sort((a,b)=>b.localeCompare(a));
            let tS = 0, tE = 0;
            sorted.forEach(d => {
                const day = daily[d];
                tS += day.s; tE += day.e;
                tb.innerHTML += `<tr><td class="table-cell font-bold">${fmtDate(d)}</td><td class="table-cell text-right text-green-600 font-medium">${fmtMoney(day.s)}</td><td class="table-cell text-right text-red-600">${fmtMoney(day.e)}</td><td class="table-cell text-right font-bold ${day.s-day.e>=0?'text-green-800':'text-red-600'}">${fmtMoney(day.s-day.e)}</td></tr>`;
            });
            
            // Actualizar resumen en header (Nuevo Diseño)
            $('profitHeaderSummary').innerHTML = `<span class="text-green-700">Ganancia: ${fmtMoney(tS-tE)}</span> <span class="text-xs text-gray-500 font-normal ml-1">(V: ${fmtMoney(tS)} - G: ${fmtMoney(tE)})</span>`;
        }

        function renderSalesList() {
            const tb = $('salesTableBody'); tb.innerHTML = '';
            const q = $('searchSaleInput').value.toLowerCase();
            const fDate = $('filterSaleDate').value;
            const fMonth = $('filterSaleMonth').value;
            const fYear = $('filterSaleYear').value;
            const list = sales.filter(s => {
                if(q && !(s.clientName||'').toLowerCase().includes(q)) return false;
                return filterByDate(s, 'date', fDate, fMonth, fYear);
            }).sort((a,b)=> (b.date+b.time).localeCompare(a.date+a.time));
            let total = 0;
            list.forEach(s => {
                total += parseFloat(s.montoCobrado)||0;
                tb.innerHTML += `<tr><td class="table-cell"><div class="font-bold">${fmtDate(s.date)}</div><div class="text-xs text-gray-500">${s.time||''}</div></td><td class="table-cell font-bold">${s.clientName}</td><td class="table-cell text-xs">${s.clothingType||'-'}</td><td class="table-cell text-xs">${s.salesChannel||'-'}</td><td class="table-cell text-xs">${s.paymentType||'-'}</td><td class="table-cell text-xs">${s.employee||'-'}</td><td class="table-cell text-right font-bold text-blue-600">${fmtMoney(s.montoCobrado)}</td></tr>`;
            });
            $('salesHistoryTotalLabel').textContent = `Total: ${fmtMoney(total)}`;
        }

        function renderExpensesList() {
            const tb = $('expensesTableBody'); tb.innerHTML = '';
            const q = $('searchExpenseInput').value.toLowerCase();
            const fDate = $('filterExpenseDate').value;
            const fMonth = $('filterExpenseMonth').value;
            const fYear = $('filterExpenseYear').value;
            const list = expenses.filter(e => {
                if(q && !(e.category||'').toLowerCase().includes(q)) return false;
                return filterByDate(e, 'date', fDate, fMonth, fYear);
            }).sort((a,b)=> b.date.localeCompare(a.date));
            let total = 0;
            list.forEach(e => {
                total += parseFloat(e.gastoTotal)||0;
                tb.innerHTML += `<tr><td class="table-cell">${fmtDate(e.date)}</td><td class="table-cell font-bold">${e.category}</td><td class="table-cell text-sm">${e.manager||'-'}</td><td class="table-cell text-right text-red-600">-${fmtMoney(e.gastoTotal)}</td></tr>`;
            });
            $('expensesHistoryTotalLabel').textContent = `Total: ${fmtMoney(total)}`;
        }

        function renderEmployeeStats() {
            const tb = $('employeeStatsTableBody'); tb.innerHTML = '';
            const mode = $('filterStatsMonth').value;
            const today = getToday();
            const thisMonth = today.slice(0,7);
            const stats = {};
            const process = (list, field, isSale) => {
                list.forEach(i => {
                    if(mode === 'all' && !i.date.startsWith(thisMonth)) return;
                    const emp = i.employee; if(!emp) return;
                    if(!stats[emp]) stats[emp] = { shifts: new Set(), w:0 };
                    if(isSale) stats[emp].shifts.add(`${i.date}_${i.shift||'D'}`);
                    else stats[emp].w += (parseFloat(i.amount)||0);
                });
            };
            process(sales, 'employee', true);
            process(withdrawals, 'employee', false);
            Object.keys(stats).forEach(e => {
                const s = stats[e];
                let h = 0; s.shifts.forEach(x => h += (x.includes('Mañana')?6:(x.includes('Tarde')?5:1)));
                tb.innerHTML += `<tr><td class="table-cell font-bold">${e}</td><td class="table-cell text-center">${s.shifts.size}</td><td class="table-cell text-center">${h}h</td><td class="table-cell text-right text-red-600">${fmtMoney(s.w)}</td></tr>`;
            });
        }

        function renderInventory() {
            const tb = $('inventoryTableBody'); tb.innerHTML = '';
            const q = $('searchInventoryInput').value.toLowerCase();
            const fDate = $('filterInvDate').value;
            const fMonth = $('filterInvMonth').value;
            const fYear = $('filterInvYear').value;
            const list = products.filter(p => {
                if(q && !p.name.toLowerCase().includes(q) && !(p.prodType||'').toLowerCase().includes(q)) return false;
                if(p.createdAt) {
                    const cDate = p.createdAt.split('T')[0];
                    return filterByDate({date: cDate}, 'date', fDate, fMonth, fYear);
                }
                return true;
            });
            list.forEach(p => tb.innerHTML += `<tr><td class="table-cell font-medium">${p.name}</td><td class="table-cell text-xs">${p.prodType||''}</td><td class="table-cell text-right font-bold">${p.stock}</td><td class="table-cell text-right text-green-600">${fmtMoney(p.priceRetail)}</td><td class="table-cell text-right text-blue-600">${p.priceUsd ? 'US$'+p.priceUsd : '-'}</td></tr>`);
        }
        
        function renderClientsTable() {
            const tb = $('clientsTableBody'); tb.innerHTML = '';
            const q = $('searchClientInput').value.toLowerCase();
            const fMonth = $('filterClientMonth').value;
            const fYear = $('filterClientYear').value;
            const list = clients.filter(c => {
                if(q && !c.name.toLowerCase().includes(q)) return false;
                if(c.createdAt) {
                    const cDate = c.createdAt.split('T')[0];
                    return filterByDate({date: cDate}, 'date', null, fMonth, fYear);
                }
                return true;
            });
            list.forEach(c => {
                const spent = sales.filter(s => (s.clientName||'').toLowerCase()===c.name.toLowerCase()).reduce((a,b)=>a+(parseFloat(b.montoCobrado)||0),0);
                tb.innerHTML += `<tr><td class="table-cell font-bold">${c.name}</td><td class="table-cell text-xs">${c.whatsapp||'-'}</td><td class="table-cell text-xs">${c.email||'-'}</td><td class="table-cell text-right font-bold text-indigo-600">${fmtMoney(spent)}</td></tr>`;
            });
        }
        function renderWithdrawalsList() {
            const tb = $('withdrawalsTableBody'); tb.innerHTML = '';
            withdrawals.sort((a,b)=>b.createdAt.localeCompare(a.createdAt)).forEach(w => tb.innerHTML += `<tr><td class="px-6 py-2 text-sm">${fmtDate(w.date)}</td><td class="px-6 py-2 text-sm font-bold">${w.employee}</td><td class="px-6 py-2 text-sm text-right text-red-600">-${fmtMoney(w.amount)}</td></tr>`);
        }

        document.addEventListener('DOMContentLoaded', () => {
            $('openSideMenuBtn').onclick = () => { $('sideMenu').classList.add('open'); $('sideMenuOverlay').classList.remove('hidden'); };
            const closeMenu = () => { $('sideMenu').classList.remove('open'); $('sideMenuOverlay').classList.add('hidden'); };
            $('closeSideMenuBtn').onclick = closeMenu; $('sideMenuOverlay').onclick = closeMenu;
            $('btnNewSale').onclick = () => { $('saleDate').value = getToday(); $('newSaleModal').classList.remove('hidden'); };
            $('btnNewExpense').onclick = () => { $('expenseDate').value = getToday(); $('newExpenseModal').classList.remove('hidden'); };
            $('btnNewProduct').onclick = () => $('productModal').classList.remove('hidden');
            $('openProfileModalBtn').onclick = () => $('profileModal').classList.remove('hidden');
            $('btnAddClientDirect').onclick = () => $('newClientModal').classList.remove('hidden');
            document.querySelectorAll('[data-close]').forEach(b => b.onclick = () => $(b.dataset.close).classList.add('hidden'));

            $('applyProfitFilterBtn').onclick = renderProfitReport;
            $('applySalesFilter').onclick = renderSalesList;
            $('resetSalesFilter').onclick = () => { $('filterSaleDate').value=''; $('filterSaleMonth').value='all'; $('filterSaleYear').value='all'; $('searchSaleInput').value=''; renderSalesList(); };
            $('applyExpenseFilter').onclick = renderExpensesList;
            $('resetExpenseFilter').onclick = () => { $('filterExpenseDate').value=''; $('filterExpenseMonth').value='all'; $('filterExpenseYear').value='all'; $('searchExpenseInput').value=''; renderExpensesList(); };
            $('applyInvFilter').onclick = renderInventory;
            $('resetInvFilter').onclick = () => { $('filterInvDate').value=''; $('filterInvMonth').value='all'; $('filterInvYear').value='all'; $('searchInventoryInput').value=''; renderInventory(); };
            $('applyClientFilter').onclick = renderClientsTable;
            $('btnOpenEmployeeStats').onclick = () => { renderEmployeeStats(); $('employeeStatsModal').classList.remove('hidden'); };
            $('refreshEmployeeStats').onclick = renderEmployeeStats;
            $('filterStatsMonth').onchange = renderEmployeeStats;

            $('saleForm').onsubmit = async(e) => {
                e.preventDefault(); if(!userId) return;
                const cName = $('saleClient').value.trim();
                const emp = $('saleEmployee').value.trim();
                if(emp && !settings.employees.includes(emp)) await setDoc(doc(db,'artifacts',appId,'users',userId,'settings','config'), {employees:arrayUnion(emp)}, {merge:true});
                if(cName && !clients.some(c=>c.name.toLowerCase()===cName.toLowerCase())) await addDoc(collection(db,'artifacts',appId,'users',userId,'clients'), {name:cName, whatsapp:$('saleWhatsapp').value, email:$('saleEmail').value, createdAt:new Date().toISOString()});
                await addDoc(collection(db,'artifacts',appId,'users',userId,'sales'), {
                    date: $('saleDate').value, time: $('saleTime').value, shift: $('saleShift').value, montoCobrado: $('saleAmount').value,
                    clientName: cName, paymentType: $('salePayment').value, salesChannel: $('saleChannel').value, clothingType: $('saleClothingType').value, employee: emp, notes: $('saleNotes').value, createdAt: new Date().toISOString()
                });
                $('newSaleModal').classList.add('hidden'); e.target.reset(); alert("Venta Guardada");
            };
            $('expenseForm').onsubmit = async(e) => {
                e.preventDefault(); if(!userId) return;
                const emp = $('expenseManager').value.trim();
                if(emp && !settings.employees.includes(emp)) await setDoc(doc(db,'artifacts',appId,'users',userId,'settings','config'), {employees:arrayUnion(emp)}, {merge:true});
                await addDoc(collection(db,'artifacts',appId,'users',userId,'expenses'), { date:$('expenseDate').value, gastoTotal:$('expenseAmount').value, category:$('expenseCategory').value, manager:emp, description:$('expenseDesc').value, createdAt: new Date().toISOString() });
                $('newExpenseModal').classList.add('hidden'); e.target.reset(); alert("Gasto Guardado");
            };
            $('productForm').onsubmit = async(e) => { e.preventDefault(); if(!userId) return; await addDoc(collection(db,'artifacts',appId,'users',userId,'products'), { name:$('prodName').value, prodType:$('prodType').value, stock:$('prodStock').value, priceRetail:$('prodPrice').value, priceUsd:$('prodPriceUsd').value, createdAt: new Date().toISOString() }); $('productModal').classList.add('hidden'); e.target.reset(); alert("Producto Guardado"); };
            $('clientForm').onsubmit = async(e) => { e.preventDefault(); if(!userId) return; await addDoc(collection(db,'artifacts',appId,'users',userId,'clients'), { name:$('newClientName').value, whatsapp:$('newClientWhatsapp').value, email:$('newClientEmail').value, createdAt: new Date().toISOString() }); $('newClientModal').classList.add('hidden'); e.target.reset(); };
            $('withdrawalForm').onsubmit = async(e) => { e.preventDefault(); if(!userId) return; await addDoc(collection(db,'artifacts',appId,'users',userId,'withdrawals'), { date:getToday(), amount:$('wdAmount').value, employee:$('wdEmployee').value, note:$('wdNote').value, createdAt:new Date().toISOString() }); $('wdAmount').value=''; $('wdNote').value=''; alert("Retiro OK"); };
            
            $('saleTime').onchange = (e) => { const [h,m] = e.target.value.split(':').map(Number); const t = h+m/60; $('saleShift').value = (t>=10&&t<16)?'Turno Mañana':((t>=16&&t<=21)?'Turno Tarde':'Fuera de Horario'); };
            $('searchSaleInput').oninput = renderSalesList;
            $('searchExpenseInput').oninput = renderExpensesList;
            $('searchInventoryInput').oninput = renderInventory;
            $('searchClientInput').oninput = renderClientsTable;
            
            document.querySelectorAll('[data-toggle-privacy]').forEach(b => {
                b.onclick = (e) => {
                    const t = e.currentTarget.dataset.togglePrivacy;
                    const els = t==='sales'?[$('cardVentasMes')]:(t==='profit'?[$('cardGananciaMes')]:[]);
                    if(privacyRevealed[t]) { els.forEach(el=>{el.classList.remove('revealed'); el.textContent='******';}); privacyRevealed[t]=false; }
                    else { pendingAction = () => { els.forEach(el=>{el.classList.add('revealed'); el.textContent=el.dataset.realValue;}); privacyRevealed[t]=true; }; $('pinInput').value=''; $('authModal').classList.remove('hidden'); $('pinInput').focus(); }
                };
            });
            $('confirmAuth').onclick = () => { if($('pinInput').value===SECURE_PIN) { if(pendingAction) pendingAction(); pendingAction=null; $('authModal').classList.add('hidden'); } else alert("PIN Incorrecto"); };
            $('cancelAuth').onclick = () => { pendingAction=null; $('authModal').classList.add('hidden'); };
            $('logoutBtn').onclick = () => { if(auth) signOut(auth).then(()=>$('profileModal').classList.add('hidden')); };
            $('googleLoginBtn').onclick = () => { if(auth) signInWithPopup(auth, new GoogleAuthProvider()).then(()=>$('profileModal').classList.add('hidden')); };

            $('openInventarioBtn').onclick = () => { renderInventory(); $('inventoryModal').classList.remove('hidden'); };
            $('openVentasHistoryBtn').onclick = () => { pendingAction = () => { renderSalesList(); $('salesHistoryModal').classList.remove('hidden'); }; $('pinInput').value=''; $('authModal').classList.remove('hidden'); $('pinInput').focus(); };
            $('openGananciasHistoryBtn').onclick = () => { 
                pendingAction = () => { 
                    if($('filterProfitMonth')) $('filterProfitMonth').value = new Date().getMonth().toString();
                    renderProfitReport(); 
                    $('gananciasDetailModal').classList.remove('hidden'); 
                }; 
                $('pinInput').value=''; $('authModal').classList.remove('hidden'); $('pinInput').focus(); 
            };
            $('openGastosHistoryBtn').onclick = () => { renderExpensesList(); $('expensesHistoryModal').classList.remove('hidden'); };
            $('openClientesBtn').onclick = () => { renderClientsTable(); $('clientsModal').classList.remove('hidden'); };
            $('btnOpenCashModal').onclick = () => { pendingAction = () => { renderWithdrawalsList(); $('cashDetailModal').classList.remove('hidden'); }; $('pinInput').value=''; $('authModal').classList.remove('hidden'); $('pinInput').focus(); };
        });

        function renderEmployeeList() {
            const c = $('employeeListContainer'); c.innerHTML = '';
            (settings.employees||[]).forEach(emp => {
                const div = document.createElement('div'); div.className = "flex justify-between items-center bg-gray-50 p-3 rounded-lg border";
                div.innerHTML = `<span class="font-medium text-gray-700">${emp}</span>`;
                const btn = document.createElement('button'); btn.innerHTML = '<i class="fas fa-trash-alt"></i>'; btn.className = "text-red-400 hover:text-red-600";
                btn.onclick = async () => { if(confirm("¿Eliminar?")) await updateDoc(doc(db,'artifacts',appId,'users',userId,'settings','config'), {employees:arrayRemove(emp)}); };
                div.appendChild(btn); c.appendChild(div);
            });
        }
    </script>
</body>
</html>
